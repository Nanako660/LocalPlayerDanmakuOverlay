# 本地播放器弹幕悬浮窗

这是一个为 Windows 本地视频播放器设计的弹幕悬浮窗应用，能够加载 Bilibili 风格的 XML 弹幕文件，并将其同步显示在屏幕顶层，让您在观看本地视频时也能享受弹幕的乐趣。

## ✨ 功能特性

- **弹幕同步**：通过监视指定播放器（如 PotPlayer、MPC-HC 等）的播放状态和进度，精确同步弹幕显示。
- **Bilibili 弹幕兼容**：支持加载从 Bilibili 下载的标准 XML 格式弹幕文件。
- **高度可定制化**：
    - **显示效果**：可自定义字体、字号、描边宽度、不透明度、行间距等。
    - **弹幕行为**：可调整滚动速度、同屏最大弹幕数量、固定弹幕持续时间。
    - **性能**：可设置最大轨道数，在性能和显示效果间取得平衡。
- **智能置顶策略**：
    - 提供多种窗口置顶方案，确保弹幕窗口在全屏游戏或应用之上也能稳定显示。
    - 智能判断，仅在目标播放器或本应用窗口在前台时显示弹幕，避免干扰。
- **图形化控制界面**：
    - 提供一个简洁的 PyQt6 控制台，方便加载弹幕、启停播放以及调整设置。
    - 所有设置均可图形化修改，并支持**热重载**，无需重启程序即可应用新配置。
- **状态记忆**：自动记录上次使用的弹幕文件路径，方便下次直接加载。
- **调试模式**：内置调试模式，可实时查看 FPS、同屏弹幕数量等信息，便于性能分析和问题排查。

## ⚙️ 依赖安装

本项目基于 Python 3，使用前请确保已安装以下依赖：

```bash
pip install PyQt6 pywin32
```

- `PyQt6`: 用于构建图形用户界面。
- `pywin32`: 用于实现高级窗口操作，是“置顶策略2”和“置顶策略3”的必要组件。

## 🚀 使用方法

1.  **启动程序**：
    直接运行 `gui.py` 即可启动主控制台。

    ```bash
    python gui.py
    ```

2.  **加载弹幕**：
    - 在主界面的“弹幕文件”输入框中，点击“浏览...”按钮，选择一个 `.xml` 格式的弹幕文件。
    - 程序会自动记住该路径，下次启动时会自动填充。

3.  **开始播放**：
    - 打开你的本地播放器并开始播放视频。
    - 在本应用主界面点击“▶ 开始播放”按钮，弹幕即会根据播放器进度开始显示。

4.  **调整设置**：
    - 点击左侧导航栏的“设置”进入设置页面。
    - 在此可以调整字体、速度、不透明度等各种参数。
    - **应用更改 (热重载)**：修改设置后，点击此按钮可立即生效，正在播放的弹幕会无缝重启并应用新配置。
    - **保存到文件**：将当前设置保存到 `config.ini` 文件，以便下次启动时自动加载。

### `config.ini` 配置说明

大部分配置都可以在 GUI 中完成，但 `target_aumid` 等核心配置建议直接修改 `config.ini` 文件。

- `[Sync]`
    - `target_aumid`: **核心配置**。目标播放器的应用程序用户模型 ID (AUMID)。程序启动时会自动检测当前运行的媒体应用及其 AUMID，你可以从控制台输出中找到你的播放器对应的 ID 并填入此处。例如：`PotPlayer64`。
- `[OnTopStrategy]`
    - `method`: 置顶策略。
        - `1`: 标准 Qt 置顶。兼容性好，但可能被某些全屏应用覆盖。
        - `2`: Win32 强制置顶。更强力的置顶，会无条件将窗口保持在最前。
        - `3`: Win32 检查式置顶。定时检查窗口是否被覆盖，如果是则恢复其置顶状态，性能开销略高于2。
- `[Debug]`
    - `enabled`: 是否开启调试模式。
    - `info_position`: 调试信息显示位置 (`top_left`, `top_right`, `bottom_left`, `bottom_right`)。

## 📁 文件结构

```
. (LocalPlayerDannakuOverlay)
├── gui.py                # GUI主程序，应用入口
├── main.py               # 核心应用逻辑，负责同步和调度
├── danmaku_renderer.py   # 弹幕渲染器，负责弹幕的绘制和动画
├── danmaku_player.py     # (旧版) 早期独立的弹幕播放器实现
├── danmaku_parser.py     # XML弹幕文件解析器
├── danmaku_models.py     # 弹幕相关的数据模型
├── config_loader.py      # 负责加载和保存 config.ini 配置文件
├── media_monitor.py      # Windows媒体会话监视器
├── config.ini            # 默认配置文件
└── ...
```

## 📄 许可

本项目采用 [MIT License](LICENSE) 开源。